<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Half-of-Average Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-light: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .shell {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: minmax(0, 2.5fr) minmax(0, 1.8fr);
      gap: 2rem;
    }

    @media (max-width: 800px) {
      .shell {
        grid-template-columns: 1fr;
      }
    }

    .card, .side-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      padding: 1.5rem;
    }

    h1 {
      margin: 0 0 0.4rem;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
    }

    p {
      margin: 0.4rem 0;
    }

    .desc {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 1.25rem;
    }

    label {
      font-weight: 600;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 0.3rem;
    }

    input[type="number"] {
      width: 100%;
      font-size: 1rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .g-recaptcha {
      margin: 1rem 0;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    button {
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      border-radius: 8px;
      padding: 0.55rem 1.1rem;
      transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(37,99,235,0.2);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: var(--text-main);
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .error {
      color: var(--danger);
      margin-top: 0.8rem;
      background: #fee2e2;
      padding: 0.5rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #fecaca;
      font-size: 0.9rem;
    }

    .result {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 10px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
    }

    .result p {
      margin: 0.4rem 0;
      font-size: 0.95rem;
    }

    .winner {
      color: var(--success);
      font-weight: 600;
    }

    .loser {
      color: var(--danger);
      font-weight: 500;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.5rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
    }

    th {
      color: var(--text-muted);
      font-weight: 500;
    }

    td {
      color: var(--text-main);
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .side-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.6rem;
    }

    .side-header h2 {
      font-size: 1.1rem;
      margin: 0;
      color: var(--text-main);
    }

    .empty {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-top: 1rem;
    }

  </style>

  <!-- Google reCAPTCHA v2 -->
  <!-- <script src="https://www.google.com/recaptcha/api.js" async defer></script> -->
</head>
<body>
  <div class="shell">

    <div class="card">
      <h1>Half-of-Average</h1>
        <p class="desc">
          <strong>Rule:</strong> This is a classic game theory exercise.
          Each player picks a number between 0 and 100.
          The winner is the one whose choice is closest to <strong>half of the average</strong> of all submitted numbers.
          <br>
          <br>
          What would be the optimal choice?
          <br>
          Play this game and share to your friends. Big data will help find out!
          <br>
          <br>
          <strong>Goal:</strong> Try to outthink the crowd and pick the optimal number.
        </p>
      
      <form method="POST" action="/vote">
        <label for="value">Your number</label>
        <input id="value" name="value" type="number" min="0" max="100" required>

        <!-- <div class="g-recaptcha" data-sitekey="<%= recaptchaSiteKey %>"></div> -->

        <div class="btn-row">
          <button type="submit" class="btn-primary">Submit</button>
          <button type="button" class="btn-secondary" id="shareBtn">Copy Link / Share</button>
        </div>
      </form>

      <% if (result && result.error) { %>
        <div class="error"><%= result.error %></div>
      <% } %>

      <% if (result && !result.error && result.average !== null) { %>
        <div class="result">
          <p>You submitted: <strong><%= result.userValue %></strong></p>
          <p>Current average: <strong><%= result.average.toFixed(2) %></strong></p>
          <p>Half of average: <strong><%= result.target.toFixed(2) %></strong></p>
          <p>Total votes: <%= result.totalVotes %></p>
          <p>
            Result:
            <% if (result.isWinner) { %>
              <span class="winner">üéâ You are currently one of the winners!</span>
            <% } else { %>
              <span class="loser">‚ùå Not the winner yet.</span>
            <% } %>
          </p>
        </div>
      <% } %>
    </div>

    <div class="side-card">
      <div class="side-header">
        <h2>Latest Activity</h2>
        <span class="muted">Last 10 votes</span>
      </div>

      <% if (recentVotes && recentVotes.length > 0) { %>
        <table>
          <thead>
            <tr>
              <th>Value</th>
              <th>Location</th>
              <th>Time (UTC)</th>
            </tr>
          </thead>
          <tbody>
            <% recentVotes.forEach(function(vote) { %>
              <tr>
                <td><strong><%= vote.value %></strong></td>
                <td><%= vote.location || 'Unknown' %></td>
                <td class="muted">
                  <%= vote.created_at.toISOString ? vote.created_at.toISOString().slice(11,19) : vote.created_at %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } else { %>
        <p class="empty">No votes yet ‚Äî be the first to play!</p>
      <% } %>
    </div>

  </div>

  <script>
    const shareBtn = document.getElementById('shareBtn');
    shareBtn.addEventListener('click', async () => {
      const url = window.location.origin + window.location.pathname;
      if (navigator.share) {
        await navigator.share({ title: 'Half-of-Average Game', text: 'Play this number game!', url });
      } else if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(url);
        alert('Link copied!');
      } else {
        prompt('Copy link:', url);
      }
    });
  </script>
</body>
</html>
