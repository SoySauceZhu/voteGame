<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Half-of-Average Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-light: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .shell {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: minmax(0, 2.5fr) minmax(0, 1.8fr);
      gap: 2rem;
    }

    @media (max-width: 800px) {
      .shell {
        grid-template-columns: 1fr;
      }
    }

    .card, .side-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      padding: 1.5rem;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
    }

    p {
      margin: 0.4rem 0;
    }

    .desc {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 1.25rem;
    }

    label {
      font-weight: 600;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 0.3rem;
    }

    input[type="number"] {
      width: 100%;
      font-size: 1rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .g-recaptcha {
      margin: 1rem 0;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    button {
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      border-radius: 8px;
      padding: 0.55rem 1.1rem;
      transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(37,99,235,0.2);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: var(--text-main);
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .error {
      color: var(--danger);
      margin-top: 0.8rem;
      background: #fee2e2;
      padding: 0.5rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #fecaca;
      font-size: 0.9rem;
    }

    .result {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 10px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
    }

    .result p {
      margin: 0.4rem 0;
      font-size: 0.95rem;
    }

    .winner {
      color: var(--success);
      font-weight: 600;
    }

    .loser {
      color: var(--danger);
      font-weight: 500;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.5rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
    }

    th {
      color: var(--text-muted);
      font-weight: 500;
    }

    td {
      color: var(--text-main);
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .side-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.6rem;
    }

    .side-header h2 {
      font-size: 1.1rem;
      margin: 0;
      color: var(--text-main);
    }

    .empty {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-top: 1rem;
    }

    /* è¯­è¨€åˆ‡æ¢ */

    .lang-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: #f9fafb;
    }

    .lang-toggle button {
      font-size: 0.8rem;
      padding: 0.35rem 0.75rem;
      border-radius: 0;
      border: none;
      background: transparent;
    }

    .lang-toggle button.active {
      background: var(--accent);
      color: #fff;
    }

    /* en/zh æ˜¾ç¤ºæ§åˆ¶ */
    .en { display: inline; }
    .zh { display: none; }

    body.lang-zh .en { display: none; }
    body.lang-zh .zh { display: inline; }

    body.lang-en .en { display: inline; }
    body.lang-en .zh { display: none; }

  </style>

  <!-- Google reCAPTCHA v2 -->
  <!-- <script src="https://www.google.com/recaptcha/api.js" async defer></script> -->
</head>
<body class="lang-en">
  <div class="shell">

    <div class="card">
      <div class="header-row">
        <div>
          <h1>
            <span class="en">Half-of-Average</span>
            <span class="zh">å¹³å‡æ•°çš„ä¸€åŠæ¸¸æˆ</span>
          </h1>
        </div>
        <div class="lang-toggle">
          <button type="button" data-lang-btn="en" class="active">EN</button>
          <button type="button" data-lang-btn="zh">ä¸­æ–‡</button>
        </div>
      </div>

      <p class="desc">
        <span class="en">
          Hi, ever heard about game theory?
          <br><br>
          Part of game theory studies includes strategic interactions where the outcome for each participant depends on the actions of all.
          <br><br>
          Here's a simple yet intriguing game for you to try!
          <br><br>
          <strong>Rule:</strong> This is a classic game theory exercise.
          Each player picks a number between 0 and 100.
          The winner is the one whose choice is closest to <strong>half of the average</strong> of all submitted numbers.
          <br><br>
          What would be the optimal choice?
          <br>
          Play this game and share to your friends. Big data will help find out!
        </span>
        <span class="zh">
          å—¨ï¼Œä½ å¬è¯´è¿‡åšå¼ˆè®ºå—ï¼Ÿ
          <br><br>
          åšå¼ˆè®ºçš„ä¸€éƒ¨åˆ†ç ”ç©¶çš„æ˜¯ï¼šå½“æ¯ä¸ªäººçš„ç»“æœéƒ½å–å†³äºæ‰€æœ‰äººçš„é€‰æ‹©æ—¶ï¼Œå¤§å®¶ä¼šå¦‚ä½•åšå†³ç­–ã€‚
          <br><br>
          ä¸‹é¢è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªæ—¢ç®€å•åˆè€äººå¯»å‘³çš„å°å®éªŒã€‚
          <br><br>
          <strong>è§„åˆ™ï¼š</strong> æ¯ä½ç©å®¶é€‰æ‹©ä¸€ä¸ª 0â€“100 ä¹‹é—´çš„æ•°å­—ã€‚  
          æŠŠæ‰€æœ‰äººçš„æ•°å­—å–å¹³å‡å€¼ï¼Œå†ç®—å‡ºè¿™ä¸ªå¹³å‡å€¼çš„ä¸€åŠï¼Œ<strong>è°é€‰çš„æ•°å­—æœ€æ¥è¿‘è¿™ä¸€åŠ</strong>ï¼Œè°å°±è·èƒœã€‚
          <br><br>
          é‚£ä¹ˆï¼Œæœ€â€œèªæ˜â€çš„é€‰æ‹©åº”è¯¥æ˜¯å¤šå°‘å‘¢ï¼Ÿ
          <br>
          å‚ä¸è¿™ä¸ªæ¸¸æˆå¹¶è½¬å‘ç»™ä½ çš„æœ‹å‹å§ï¼Œè®©å¤§å®¶ä¸€èµ·ç”¨â€œå¤§æ•°æ®â€æ¥æ‰¾ç­”æ¡ˆã€‚
        </span>
      </p>
      
      <form method="POST" action="/vote">
        <label for="value">
          <span class="en">Your number</span>
          <span class="zh">ä½ çš„æ•°å­—</span>
        </label>
        <input id="value" name="value" type="number" min="0" max="100" required>
        <input type="hidden" id="playerIdInput" name="player_id" value="">

        <div class="btn-row">
          <button type="submit" class="btn-primary">
            <span class="en">Submit</span>
            <span class="zh">æäº¤</span>
          </button>
          <button type="button" class="btn-secondary" id="shareBtn">
            <span class="en">Copy Link / Share</span>
            <span class="zh">å¤åˆ¶é“¾æ¥ / åˆ†äº«</span>
          </button>
        </div>
      </form>

      <% if (result && result.error) { %>
        <div class="error">
          <!-- å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥åœ¨åç«¯ä¹Ÿè¿”å›ä¸­æ–‡é”™è¯¯ï¼Œè¿™é‡Œå°±éƒ½èƒ½æ˜¾ç¤º -->
          <span class="en"><%= result.error %></span>
          <span class="zh"><%= result.errorZh || result.error %></span>
        </div>
      <% } %>

      <% if (result && !result.error && result.average !== null) { %>
        <div class="result">
          <p>
            <span class="en">
              You submitted: <strong><%= result.userValue %></strong>
            </span>
            <span class="zh">
              ä½ æäº¤çš„æ•°å­—ï¼š<strong><%= result.userValue %></strong>
            </span>
          </p>
          <p>
            <span class="en">
              Current average: <strong><%= result.average.toFixed(2) %></strong>
            </span>
            <span class="zh">
              å½“å‰æ‰€æœ‰ç©å®¶çš„å¹³å‡å€¼ï¼š<strong><%= result.average.toFixed(2) %></strong>
            </span>
          </p>
          <p>
            <span class="en">
              Half of average: <strong><%= result.target.toFixed(2) %></strong>
            </span>
            <span class="zh">
              å¹³å‡å€¼çš„ä¸€åŠï¼š<strong><%= result.target.toFixed(2) %></strong>
            </span>
          </p>
          <p>
            <span class="en">
              Total votes: <%= result.totalVotes %>
            </span>
            <span class="zh">
              å½“å‰æ€»å‚ä¸äººæ•°ï¼š<%= result.totalVotes %>
            </span>
          </p>
          <p>
            <span class="en">Result: </span>
            <span class="zh">ç»“æœï¼š</span>
            <% if (result.isWinner) { %>
              <span class="en winner">ğŸ‰ You are currently one of the winners!</span>
              <span class="zh winner">ğŸ‰ ä½ ç›®å‰æ˜¯è·èƒœè€…ä¹‹ä¸€ï¼</span>
            <% } else { %>
              <span class="en loser">âŒ Not the winner yet.</span>
              <span class="zh loser">âŒ ç›®å‰è¿˜ä¸æ˜¯è·èƒœè€…ã€‚</span>
            <% } %>
          </p>
        </div>
      <% } %>
    </div>

    <div class="side-card">
      <div class="side-header">
        <h2>
          <span class="en">Latest Activity</span>
          <span class="zh">æœ€æ–°å‚ä¸è®°å½•</span>
        </h2>
        <span class="muted">
          <span class="en">Last 10 votes</span>
          <span class="zh">æœ€è¿‘ 10 æ¬¡æäº¤</span>
        </span>
      </div>

      <% if (recentVotes && recentVotes.length > 0) { %>
        <table>
          <thead>
            <tr>
              <th>
                <span class="en">Value</span>
                <span class="zh">æ•°å­—</span>
              </th>
              <th>
                <span class="en">Location</span>
                <span class="zh">åœ°åŒº</span>
              </th>
              <th>
                <span class="en">Time (UTC)</span>
                <span class="zh">æ—¶é—´ï¼ˆUTCï¼‰</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <% recentVotes.forEach(function(vote) { %>
              <tr>
                <td><strong><%= vote.value %></strong></td>
                <td><%= vote.location || 'Unknown' %></td>
                <td class="muted">
                  <%= vote.created_at.toISOString ? vote.created_at.toISOString().slice(11,19) : vote.created_at %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } else { %>
        <p class="empty">
          <span class="en">No votes yet â€” be the first to play!</span>
          <span class="zh">è¿˜æ²¡æœ‰ä»»ä½•æäº¤ â€” æˆä¸ºç¬¬ä¸€ä¸ªå‚ä¸çš„äººå§ï¼</span>
        </p>
      <% } %>
    </div>

  </div>

<script>
  /***********************
   * ğŸ§  1. Player ID æŒä¹…åŒ–æœºåˆ¶
   *    (localStorage + ?pid=... å…¼å®¹å¾®ä¿¡å¤š WebView)
   ***********************/
  (function () {
    const url = new URL(window.location.href);
    const params = url.searchParams;
    let pid = params.get('pid');

    // ä» URLã€localStorage æ¢å¤æˆ–ç”Ÿæˆæ–°çš„ player_id
    if (!pid) {
      pid = localStorage.getItem('player_id');
    }
    if (!pid) {
      if (window.crypto && crypto.randomUUID) {
        pid = crypto.randomUUID();
      } else {
        pid = 'pid_' + Math.random().toString(36).slice(2);
      }
    }

    // å†™å…¥ localStorage
    localStorage.setItem('player_id', pid);

    // å¦‚æœ URL é‡Œæ²¡å¸¦ pidï¼Œåˆ™è¡¥ä¸Š
    if (!params.get('pid')) {
      params.set('pid', pid);
      const newUrl = url.origin + url.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newUrl);
    }

    // æŠŠ player_id å†™è¿›éšè— inputï¼ˆæäº¤ç»™åç«¯ï¼‰
    const pidInput = document.getElementById('playerIdInput');
    if (pidInput) pidInput.value = pid;

    // æš´éœ²ç»™å…¶ä»–é€»è¾‘ï¼ˆä¾‹å¦‚åˆ†äº«ï¼‰
    window.__PLAYER_ID__ = pid;
  })();


  /***********************
   * ğŸŒ 2. è¯­è¨€åˆ‡æ¢é€»è¾‘
   ***********************/
  const langButtons = document.querySelectorAll('[data-lang-btn]');
  let currentLang = 'en';

  function setLanguage(lang) {
    currentLang = lang;
    document.body.classList.toggle('lang-en', lang === 'en');
    document.body.classList.toggle('lang-zh', lang === 'zh');
    document.documentElement.setAttribute('lang', lang === 'zh' ? 'zh-CN' : 'en');

    langButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.langBtn === lang);
    });

    try {
      localStorage.setItem('lang', lang);
    } catch (e) {}
  }

  // åˆå§‹åŒ–è¯­è¨€ï¼šlocalStorage ä¼˜å…ˆ â†’ æµè§ˆå™¨è¯­è¨€
  (function initLang() {
    let saved = null;
    try {
      saved = localStorage.getItem('lang');
    } catch (e) {}
    if (saved === 'en' || saved === 'zh') {
      setLanguage(saved);
    } else {
      const navLang = (navigator.language || '').toLowerCase();
      if (navLang.startsWith('zh')) {
        setLanguage('zh');
      } else {
        setLanguage('en');
      }
    }
  })();

  langButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const lang = btn.dataset.langBtn;
      setLanguage(lang);
    });
  });


  /***********************
   * ğŸ”— 3. åˆ†äº«æŒ‰é’®é€»è¾‘
   *    ï¼ˆè‡ªåŠ¨å¸¦ä¸Š pidï¼Œè®©åˆ†äº«çš„äººåœ¨å¾®ä¿¡ä¹Ÿèƒ½æ¢å¤åŒä¸€ä¸ªç©å®¶èº«ä»½ï¼‰
   ***********************/
  const shareBtn = document.getElementById('shareBtn');
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      // å½“å‰ URL å·²ç»åŒ…å« ?pid=xxx
      const url = window.location.href;
      const title = currentLang === 'zh' ? 'å¹³å‡æ•°çš„ä¸€åŠæ¸¸æˆ' : 'Half-of-Average Game';
      const text = currentLang === 'zh'
        ? 'æ¥ç©è¿™ä¸ªæœ‰è¶£çš„æ•°å­—æ¸¸æˆï¼Œçœ‹ä½ èƒ½å¦çŒœä¸­å¤§å®¶çš„æƒ³æ³•ï¼'
        : 'Play this number game and see if you can outthink the crowd!';

      try {
        if (navigator.share) {
          await navigator.share({ title, text, url });
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
          alert(currentLang === 'zh' ? 'é“¾æ¥å·²å¤åˆ¶ï¼' : 'Link copied!');
        } else {
          prompt(currentLang === 'zh' ? 'å¤åˆ¶æ­¤é“¾æ¥ï¼š' : 'Copy this link:', url);
        }
      } catch (err) {
        console.error('Share failed:', err);
      }
    });
  }
</script>

</body>
</html>
